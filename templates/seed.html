{% load staticfiles %}

<script src="{% static 'browse/js/xhr@latest.js' %}"></script>
<script src="{% static 'browse/js/msa@0.4.0.js' %}"></script>
<script src="{% static 'browse/js/biojs-io-fasta.js' %}"></script>


<div id="container" style="margin-top:5px;">
	<div id="row">
		<div id="col-xs-12">
			<div class="btn-toolbar pull-right" role="toolbar" aria-label="...">
				<div class="btn-group">
					<div class="btn-group">
					  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
					    Order <span class="caret"></span>
					  </button>
					  <ul class="dropdown-menu" role="menu">
					  	<li><a href="#" id="msa_order_id">ID</a></li>
					    <li><a href="#" id="msa_order_label">Label</a></li>
					    <li><a href="#" id="msa_order_seq">Seq</a></li>
					    <li><a href="#" id="msa_order_identity">Identity</a></li>
					    <li><a href="#" id="msa_order_gaps">Gaps</a></li>
					    <li class="divider"></li>
					    <li><a href="#" id="msa_order_reverse">Reversed</a></li>
					  </ul>
					</div>
					<div class="btn-group">
					  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
					    Filter <span class="caret"></span>
					  </button>
					  <ul class="dropdown-menu" role="menu">
					  	<li><a href="#" id="msa_filter_col_threshold">Hide columns by threshold</a></li>
					  	<li><a href="#" id="msa_filter_col_selection">Hide columns by selection</a></li>
					  	<li><a href="#" id="msa_filter_col_gaps">Hide columns by gaps</a></li>
					  	<li><a href="#" id="msa_filter_seqs_idenitity">Hide seqs by idenity</a></li>
					  	<li><a href="#" id="msa_filter_seqs_selection">Hide seqs by selection</a></li>
					  	<li><a href="#" id="msa_filter_seqs_gaps">Hide seqs by gaps</a></li>
					  	<li class="divider"></li>
					    <li><a href="#" id="msa_filter_reset">Reset</a></li>
					  </ul>
					</div>
					<div class="btn-group">
					  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
					    Select <span class="caret"></span>
					  </button>
					  <ul class="dropdown-menu" role="menu">
					  	<li><a href="#" id="msa_select_find">Find Motif (supports Regex)</a></li>
					  	<li><a href="#" id="msa_select_invert_cols">Invert columns</a></li>
					  	<li><a href="#" id="msa_select_invert_rows">Invert rows</a></li>
					  	<li class="divider"></li>
					    <li><a href="#" id="msa_select_reset">Reset</a></li>
					  </ul>
					</div>
					<div class="btn-group">
					  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
					    View <span class="caret"></span>
					  </button>
					  <ul class="dropdown-menu" role="menu">
					  	<li><a href="#" id="msa_view_tree">Tree</a></li>
					  	<li class="divider"></li>
					  	<li><a href="#" id="msa_view_col">Jump to column</a></li>
					  	<li class="divider"></li>
					  	<li><a href="#" id="msa_view_font+">Increase font size</a></li>
					    <li><a href="#" id="msa_view_font-">Decrease font size</a></li>
					  </ul>
					</div>
					<div class="btn-group">
					  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
					    Export <span class="caret"></span>
					  </button>
					  <ul class="dropdown-menu" role="menu">
					  	<li><a href="#" id="msa_export_pdf">Save as PDF</a></li>
					  	<li><a href="#" id="msa_export_png">Save as PNG</a></li>
					  	<li class="divider"></li>
					  	<li><a href="#" id="msa_export_fasta_all">Save FASTA (All)</a></li>
					    <li><a href="#" id="msa_export_fasta_selection">Save FASTA (Selected)</a></li>
					    <li class="divider"></li>
					  	<li><a href="#" id="msa_export_features">Save Features (GFF)</a></li>
					  </ul>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="row" style="margin-top:5px;">
		<div id="col-xs-12">
			<div id="container"><div id='snippetDiv'></div></div>
		</div>
	</div>
</div>

<script>
$(document).ready(function() {
	var yourDiv = document.getElementById('snippetDiv');

	/* global yourDiv */
	var msa = require("msa");
	var fasta = require("biojs-io-fasta");

	var msaDiv = document.createElement('div');
	yourDiv.appendChild(msaDiv);

	var opts = {
	  el: msaDiv
	}
	opts.vis = {
	  conserv: false,
	  overviewbox: false,
	  seqlogo: true,
	  markers: false,
	  leftHeader: false,
	  labelName: false,
	};
	opts.zoomer = {
	  labelIdLength: 160,
	  alignmentHeight: 500,
	  alignmentWidth: 975,
	};

	// init msa
	var m = msa(opts);

	//load sequences
	fasta.read("{% static seed_file %}", function(err, seqs){
    	m.seqs.reset(seqs);
    	m.render();
	});

	var colorConservation = {}

	// the init function is only called once
	colorConservation.init = function(){
	  // you have here access to the conservation or the sequence object
	  this.cons = this.opt.conservation();
	  this.cons80 = true;
	  this.cons50 = true;
	}

	colorConservation.run = function(letter,opts){
	  if(this.cons80 && this.cons[opts.pos] > 0.8){
	  	return "red";
	  }
	  else if(this.cons50 && this.cons[opts.pos] > 0.5){
	  	return "blue";
	  }
	  else{
	  	return "#000";
	  }
	};

	m.g.colorscheme.addDynScheme("colorConservation", colorConservation);
	m.g.colorscheme.set("scheme", "colorConservation");
});

</script>
